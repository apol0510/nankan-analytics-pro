<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NANKAN Analytics Pro - デモサイト</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg-main: #0f172a;
            --bg-card: #1e293b;
            --bg-card-hover: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
            --shadow: rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', Meiryo, sans-serif;
            background: var(--bg-main);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            background: var(--bg-card);
            border-bottom: 2px solid var(--primary);
            padding: 20px 0;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px var(--shadow);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            font-size: 28px;
            color: var(--text-primary);
            font-weight: 700;
        }

        .logo-badge {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }


        /* Admin Panel */
        .admin-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        @media (max-width: 1024px) {
            .admin-panel {
                grid-template-columns: 1fr;
            }
        }

        .panel-section {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px var(--shadow);
        }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 24px;
            background: var(--primary);
            border-radius: 2px;
        }

        textarea {
            width: 100%;
            min-height: 300px;
            padding: 15px;
            background: var(--bg-main);
            color: var(--text-primary);
            border: 2px solid var(--border);
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 14px;
            resize: vertical;
            transition: border-color 0.3s ease;
        }

        textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        button {
            padding: 12px 24px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        button:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
        }

        button:disabled {
            background: var(--border);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: var(--bg-card-hover);
        }

        .btn-secondary:hover {
            background: var(--border);
            box-shadow: 0 4px 12px rgba(51, 65, 85, 0.4);
        }

        .btn-success {
            background: var(--success);
        }

        .btn-success:hover {
            background: #059669;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        /* Status Message */
        .status-message {
            margin-top: 15px;
            padding: 12px 16px;
            border-radius: 8px;
            font-weight: 600;
            display: none;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .status-message.success {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
            border: 1px solid var(--success);
            display: block;
        }

        .status-message.error {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
            border: 1px solid var(--danger);
            display: block;
        }

        /* Preview Area */
        #preview-area {
            min-height: 400px;
            position: relative;
            border: 2px dashed rgba(148, 163, 184, 0.3);
            border-radius: 8px;
            padding: 20px;
            background: var(--bg-main);
        }

        #preview-area::after {
            content: '📋 データ確認用プレビュー（簡易表示）';
            position: absolute;
            top: -12px;
            left: 20px;
            background: var(--bg-card);
            color: var(--text-secondary);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            z-index: 3;
            border: 1px solid rgba(148, 163, 184, 0.3);
        }

        #preview-area > * {
            position: relative;
            z-index: 2;
        }

        /* Preview Simple Table */
        .preview-race {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
        }

        .preview-race-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .preview-table th {
            text-align: left;
            padding: 8px;
            color: var(--text-secondary);
            font-weight: 600;
            background: var(--bg-main);
        }

        .preview-table td {
            padding: 8px;
            color: var(--text-primary);
            border-top: 1px solid var(--border);
        }


        /* Race Card */
        .race-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px var(--shadow);
            border: 1px solid var(--border);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .race-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px var(--shadow);
        }

        .race-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border);
        }

        .race-title {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .race-meta {
            display: flex;
            gap: 15px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Horse Table */
        .horse-table {
            width: 100%;
            border-collapse: collapse;
        }

        .horse-table thead {
            background: var(--bg-main);
        }

        .horse-table th {
            padding: 12px;
            text-align: left;
            font-weight: 700;
            font-size: 13px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .horse-table td {
            padding: 15px 12px;
            border-top: 1px solid var(--border);
        }

        .horse-table tbody tr {
            transition: background 0.2s ease;
        }

        .horse-table tbody tr:hover {
            background: var(--bg-card-hover);
        }

        .rank-badge {
            display: inline-block;
            width: 32px;
            height: 32px;
            line-height: 32px;
            text-align: center;
            border-radius: 50%;
            font-weight: 700;
            font-size: 14px;
        }

        .rank-1 {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: #78350f;
        }

        .rank-2 {
            background: linear-gradient(135deg, #d1d5db, #9ca3af);
            color: #1f2937;
        }

        .rank-3 {
            background: linear-gradient(135deg, #f87171, #dc2626);
            color: white;
        }

        .rank-other {
            background: var(--bg-main);
            color: var(--text-secondary);
        }

        .horse-number {
            font-weight: 700;
            color: var(--text-primary);
            font-size: 16px;
        }

        .horse-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .score-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-main);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }

        .score-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--success));
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .probability {
            font-size: 18px;
            font-weight: 700;
            color: var(--success);
        }

        /* Professional Styles */
        .data-grid {
            overflow-x: auto;
        }

        .analysis-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .analysis-table thead {
            background: var(--bg-main);
        }

        .analysis-table th {
            padding: 12px 10px;
            text-align: center;
            font-weight: 700;
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid var(--border);
        }

        .analysis-table td {
            padding: 14px 10px;
            text-align: center;
            border-bottom: 1px solid var(--border);
        }

        .rank-cell {
            font-weight: 700;
            font-size: 16px;
        }

        .horse-num {
            font-weight: 700;
            color: var(--primary);
            font-size: 15px;
        }

        /* Score Bars */
        .score-cell {
            position: relative;
            padding: 4px;
        }

        .score-value {
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .score-bar-mini {
            width: 100%;
            height: 4px;
            background: var(--bg-main);
            border-radius: 2px;
            overflow: hidden;
        }

        .score-fill-mini {
            height: 100%;
            border-radius: 2px;
            transition: width 0.5s ease;
        }

        .fill-total { background: linear-gradient(90deg, #3b82f6, #06b6d4); }
        .fill-speed { background: linear-gradient(90deg, #10b981, #14b8a6); }
        .fill-stable { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
        .fill-power { background: linear-gradient(90deg, #ef4444, #f97316); }
        .fill-adapt { background: linear-gradient(90deg, #8b5cf6, #a78bfa); }

        .prob-cell {
            font-size: 16px;
            font-weight: 700;
            color: var(--success);
        }

        /* Legend */
        .legend {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            font-size: 11px;
            color: var(--text-secondary);
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend-bar {
            width: 30px;
            height: 4px;
            border-radius: 2px;
        }

        /* Betting Recommendations */
        .betting-section {
            background: var(--bg-main);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid var(--primary);
        }

        .betting-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .betting-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .betting-item {
            background: var(--bg-card);
            padding: 12px 15px;
            border-radius: 6px;
            border: 1px solid var(--border);
        }

        .betting-type {
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .betting-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--success);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-text {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .empty-subtext {
            font-size: 14px;
        }

        /* Footer */
        footer {
            margin-top: 60px;
            padding: 30px 0;
            border-top: 1px solid var(--border);
            text-align: center;
            color: var(--text-secondary);
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 15px;
        }

        .footer-links a {
            color: var(--text-secondary);
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .footer-links a:hover {
            color: var(--primary);
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <h1>🏇 NANKAN Analytics Pro</h1>
            <div class="logo-badge">Demo System</div>
        </div>
    </header>

    <div class="container">
            <div class="admin-panel">
                <!-- Input Section -->
                <div class="panel-section">
                    <h2 class="section-title">予想データ入力</h2>

                    <!-- URL Input Mode (NEW!) -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="color: white; font-weight: bold; margin-bottom: 10px; font-size: 16px;">
                            🚀 最も簡単！URLを貼り付けるだけ
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <input
                                type="text"
                                id="race-url"
                                placeholder="例: https://www.nankankeiba.com/uma_shosai/2025102020110101.do"
                                style="flex: 1; padding: 12px; border: none; border-radius: 6px; font-size: 14px;"
                            />
                            <button
                                onclick="fetchFromURL()"
                                style="padding: 12px 24px; background: white; color: #667eea; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; white-space: nowrap;"
                            >
                                🔄 自動取得
                            </button>
                        </div>
                        <div id="url-status" style="margin-top: 10px; color: white; font-size: 13px;"></div>
                    </div>

                    <textarea id="input-data" placeholder="💡 3つの入力モード対応！

【🏇 南関出馬表モード】← NEW!
1. 南関競馬の出馬表ページ全体をコピー（Ctrl+A → Ctrl+C）
2. ここに貼り付け
3. 「🏇 南関出馬表から自動生成」ボタンをクリック
→ 馬番・馬名・スコア・確率を自動生成！

【簡易版】馬番,馬名,スコア,確率 の4項目だけでOK
例：1,ホワイトサンズ,9.8,45%
　　2,ブラックナイト,8.2,38%

【詳細版】全スコア入力（5スコア）
例：1,ホワイトサンズ,9.8,8.5,7.2,6.8,5.4,45%

【Excel/スプレッドシートから貼り付けもOK】
タブ区切り・スペース区切りも自動変換されます

---レース区切り / ===買い目区切り"></textarea>
                    <div class="button-group">
                        <button onclick="loadSampleData()">
                            📋 サンプルデータ
                        </button>
                        <button onclick="parseNankanData()" class="btn-success">
                            🏇 南関出馬表から自動生成
                        </button>
                        <button onclick="clearData()" class="btn-secondary">
                            🗑️ クリア
                        </button>
                    </div>
                    <div id="input-status" class="status-message"></div>
                </div>

                <!-- Preview Section -->
                <div class="panel-section">
                    <h2 class="section-title">プレビュー</h2>
                    <div id="preview-area">
                        <div class="empty-state">
                            <div class="empty-icon">📊</div>
                            <div class="empty-text">プレビューエリア</div>
                            <div class="empty-subtext">左側にデータを入力すると、ここにプレビューが表示されます</div>
                        </div>
                    </div>
                    <div class="button-group">
                        <button id="publish-btn" onclick="publishToSite()" class="btn-success" disabled>
                            🚀 公開サイトに反映
                        </button>
                        <button id="open-btn" onclick="window.open('public.html', '_blank')" class="btn-secondary" disabled>
                            🌐 公開サイトを開く
                        </button>
                    </div>
                    <div id="preview-status" class="status-message"></div>
                </div>
            </div>
    </div>

    <footer>
        <div class="footer-links">
            <a href="https://github.com/nankan-analytics-pro">GitHub</a>
            <a href="#">ドキュメント</a>
            <a href="#">お問い合わせ</a>
        </div>
        <p>&copy; 2025 NANKAN Analytics Pro. All rights reserved.</p>
    </footer>

    <script>
        // Smart Auto-Convert Function
        function smartConvert(text) {
            const lines = text.split('\n');
            const converted = lines.map(line => {
                // Skip empty lines, headers, separators, and betting data
                if (!line.trim() || line.includes('R ') || line.trim() === '---' || line.trim() === '===' || line.includes(':')) {
                    return line;
                }

                // Detect delimiter (tab or multiple spaces)
                let parts;
                if (line.includes('\t')) {
                    parts = line.split('\t').map(p => p.trim()).filter(p => p);
                } else if (line.match(/\s{2,}/)) {
                    parts = line.split(/\s+/).map(p => p.trim()).filter(p => p);
                } else if (line.includes(',')) {
                    parts = line.split(',').map(p => p.trim()).filter(p => p);
                } else {
                    return line; // No delimiter found
                }

                // If already has 7+ parts, it's complete
                if (parts.length >= 7) {
                    return parts.join(',');
                }

                // Simple mode: 4 parts (num, name, score, prob)
                if (parts.length === 4) {
                    const [num, name, mainScore, prob] = parts;
                    const score = parseFloat(mainScore);

                    // Auto-generate 4 sub-scores based on main score
                    const score2 = (score - 0.3 - Math.random() * 0.4).toFixed(1);
                    const score3 = (score - 0.6 - Math.random() * 0.6).toFixed(1);
                    const score4 = (score - 1.0 - Math.random() * 0.8).toFixed(1);
                    const score5 = (score - 1.5 - Math.random() * 1.0).toFixed(1);

                    return `${num},${name},${mainScore},${score2},${score3},${score4},${score5},${prob}`;
                }

                // Return as-is if format is unexpected
                return parts.join(',');
            });

            return converted.join('\n');
        }

        // Auto-convert on paste
        const inputData = document.getElementById('input-data');
        inputData.addEventListener('paste', function(e) {
            setTimeout(() => {
                const converted = smartConvert(this.value);
                if (converted !== this.value) {
                    this.value = converted;
                    updatePreview();
                }
            }, 10);
        });

        // Auto-preview on input
        let debounceTimer;
        inputData.addEventListener('input', function() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                updatePreview();
            }, 500);
        });

        // Update Preview (Simple view for data confirmation)
        function updatePreview() {
            const inputData = document.getElementById('input-data').value.trim();
            const previewArea = document.getElementById('preview-area');
            const publishBtn = document.getElementById('publish-btn');

            if (!inputData) {
                previewArea.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">📊</div>
                        <div class="empty-text">プレビューエリア</div>
                        <div class="empty-subtext">左側にデータを入力すると、ここにプレビューが表示されます</div>
                    </div>
                `;
                publishBtn.disabled = true;
                return;
            }

            try {
                const html = convertToSimplePreview(inputData);
                previewArea.innerHTML = html;
                publishBtn.disabled = false;
                showStatus('input-status', 'データを読み込みました', 'success');
            } catch (error) {
                previewArea.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">⚠️</div>
                        <div class="empty-text">エラー</div>
                        <div class="empty-subtext">${error.message}</div>
                    </div>
                `;
                publishBtn.disabled = true;
                showStatus('input-status', 'データの形式が正しくありません', 'error');
            }
        }

        // Convert to Simple Preview (Plain table format)
        function convertToSimplePreview(data) {
            const races = data.split('---').map(r => r.trim()).filter(r => r);
            let html = '';

            races.forEach((race, idx) => {
                const lines = race.split('\n').filter(l => l.trim());
                if (lines.length < 2) return;

                const header = lines[0];
                const horses = lines.slice(1);

                html += `
                    <div class="preview-race">
                        <div class="preview-race-title">${header}</div>
                        <table class="preview-table">
                            <thead>
                                <tr>
                                    <th>馬番</th>
                                    <th>馬名</th>
                                    <th>スコア</th>
                                    <th>確率</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                horses.forEach((horse, i) => {
                    const parts = horse.split(',');
                    if (parts.length < 7) return;

                    const [num, name, score1, score2, score3, score4, score5, prob] = parts;

                    html += `
                        <tr>
                            <td>${num}</td>
                            <td>${name}</td>
                            <td>${score1}</td>
                            <td>${prob}</td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            });

            return html || '<div class="empty-state"><div class="empty-icon">⚠️</div><div class="empty-text">データがありません</div></div>';
        }

        // Convert data to Professional HTML
        function convertToHTML(data) {
            const races = data.split('---').map(r => r.trim()).filter(r => r);
            let html = '';

            races.forEach((race, idx) => {
                // 買い目セクションを分離
                const parts = race.split('===');
                const horseData = parts[0].trim();
                const bettingData = parts[1] ? parts[1].trim() : '';

                const lines = horseData.split('\n').filter(l => l.trim());
                if (lines.length < 2) return;

                const header = lines[0];
                const horses = lines.slice(1);

                html += `
                    <div class="race-card">
                        <div class="race-header">
                            <div class="race-title">${header}</div>
                            <div class="race-meta">
                                <div>🏇 ${horses.length}頭立て</div>
                                <div>📅 ${new Date().toLocaleDateString('ja-JP')}</div>
                                <div>⏰ ${new Date().toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'})}</div>
                            </div>
                        </div>

                        <div class="legend">
                            <div class="legend-item">
                                <div class="legend-bar fill-total"></div>
                                <span>総合評価</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-bar fill-speed"></div>
                                <span>スピード指数</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-bar fill-stable"></div>
                                <span>安定性</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-bar fill-power"></div>
                                <span>地力</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-bar fill-adapt"></div>
                                <span>適性</span>
                            </div>
                        </div>

                        <div class="data-grid">
                            <table class="analysis-table">
                                <thead>
                                    <tr>
                                        <th>順位</th>
                                        <th>馬番</th>
                                        <th style="text-align: left;">馬名</th>
                                        <th>総合</th>
                                        <th>スピード</th>
                                        <th>安定性</th>
                                        <th>地力</th>
                                        <th>適性</th>
                                        <th>的中率</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;

                horses.forEach((horse, i) => {
                    const parts = horse.split(',');
                    if (parts.length < 7) return;

                    const [num, name, score1, score2, score3, score4, score5, prob] = parts;
                    const rankClass = i === 0 ? 'rank-1' : i === 1 ? 'rank-2' : i === 2 ? 'rank-3' : '';

                    html += `
                        <tr>
                            <td class="rank-cell ${rankClass}">${i + 1}</td>
                            <td class="horse-num">${num}</td>
                            <td class="horse-name">${name}</td>
                            <td class="score-cell">
                                <div class="score-value">${score1}</div>
                                <div class="score-bar-mini">
                                    <div class="score-fill-mini fill-total" style="width: ${score1 * 10}%"></div>
                                </div>
                            </td>
                            <td class="score-cell">
                                <div class="score-value">${score2}</div>
                                <div class="score-bar-mini">
                                    <div class="score-fill-mini fill-speed" style="width: ${score2 * 10}%"></div>
                                </div>
                            </td>
                            <td class="score-cell">
                                <div class="score-value">${score3}</div>
                                <div class="score-bar-mini">
                                    <div class="score-fill-mini fill-stable" style="width: ${score3 * 10}%"></div>
                                </div>
                            </td>
                            <td class="score-cell">
                                <div class="score-value">${score4}</div>
                                <div class="score-bar-mini">
                                    <div class="score-fill-mini fill-power" style="width: ${score4 * 10}%"></div>
                                </div>
                            </td>
                            <td class="score-cell">
                                <div class="score-value">${score5}</div>
                                <div class="score-bar-mini">
                                    <div class="score-fill-mini fill-adapt" style="width: ${score5 * 10}%"></div>
                                </div>
                            </td>
                            <td class="prob-cell">${prob}</td>
                        </tr>
                    `;
                });

                html += `
                                </tbody>
                            </table>
                        </div>
                `;

                // 買い目セクションを追加
                if (bettingData) {
                    const bettingLines = bettingData.split('\n').filter(l => l.trim());
                    const bettings = {};

                    bettingLines.forEach(line => {
                        const [type, value] = line.split(':').map(s => s.trim());
                        if (type && value) {
                            bettings[type] = value;
                        }
                    });

                    html += `
                        <div class="betting-section">
                            <div class="betting-title">📋 推奨買い目</div>
                            <div class="betting-grid">
                    `;

                    if (bettings['単勝']) {
                        html += `
                            <div class="betting-item">
                                <div class="betting-type">単勝</div>
                                <div class="betting-value">${bettings['単勝']}番</div>
                            </div>
                        `;
                    }

                    if (bettings['馬単']) {
                        html += `
                            <div class="betting-item">
                                <div class="betting-type">馬単</div>
                                <div class="betting-value">${bettings['馬単'].replace('-', ' → ')}</div>
                            </div>
                        `;
                    }

                    if (bettings['三連単']) {
                        html += `
                            <div class="betting-item">
                                <div class="betting-type">三連単</div>
                                <div class="betting-value">${bettings['三連単'].replace(/-/g, ' → ')}</div>
                            </div>
                        `;
                    }

                    if (bettings['三連複']) {
                        html += `
                            <div class="betting-item">
                                <div class="betting-type">三連複</div>
                                <div class="betting-value">${bettings['三連複'].replace(/-/g, ' - ')}</div>
                            </div>
                        `;
                    }

                    html += `
                            </div>
                        </div>
                    `;
                }

                html += `
                    </div>
                `;
            });

            return html || '<div class="empty-state"><div class="empty-icon">⚠️</div><div class="empty-text">データがありません</div></div>';
        }

        // Publish to Site
        function publishToSite() {
            const inputData = document.getElementById('input-data').value.trim();

            // 元のデータからリッチなHTMLを生成
            const richHTML = convertToHTML(inputData);

            // LocalStorageに保存
            localStorage.setItem('nankan-pro-data', richHTML);

            // 公開サイトを開くボタンを有効化
            document.getElementById('open-btn').disabled = false;

            showStatus('preview-status', '✅ 公開サイトに反映しました！「公開サイトを開く」ボタンで確認できます', 'success');
        }

        // Load Sample Data
        function loadSampleData() {
            const sampleData = `5R 門別 サラ系3歳
1,ホワイトサンズ,9.8,45%
2,ブラックナイト,8.2,38%
3,レッドフレイム,7.9,35%
4,グリーンフォレスト,7.2,28%
5,ブルーオーシャン,6.8,24%
===
単勝:1
馬単:1-2
三連単:1-2-3
---
8R 盛岡 サラ系3歳以上
1,スターライト,9.2,42%
2,ムーンシャドウ,8.5,39%
3,サンライズ,8.0,36%
4,ミッドナイト,7.5,32%
5,ダスク,7.0,29%
===
単勝:1
馬単:1-2
三連単:1-2-4
三連複:1-2-3`;

            document.getElementById('input-data').value = sampleData;
            // Auto-convert to full format
            const converted = smartConvert(sampleData);
            document.getElementById('input-data').value = converted;
            updatePreview();
        }

        // Fetch Race Card from URL using Netlify Function
        async function fetchFromURL() {
            const urlInput = document.getElementById('race-url');
            const url = urlInput.value.trim();
            const statusEl = document.getElementById('url-status');

            if (!url) {
                statusEl.textContent = '⚠️ URLを入力してください';
                return;
            }

            if (!url.includes('nankankeiba.com')) {
                statusEl.textContent = '⚠️ 南関競馬のURLを入力してください';
                return;
            }

            try {
                statusEl.textContent = '🔄 出馬表を取得中...';

                // Call Netlify Function
                const response = await fetch('/.netlify/functions/fetch-race-card', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ url })
                });

                const data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error(data.error || 'Failed to fetch race card');
                }

                statusEl.textContent = '✅ 取得成功！HTMLを解析中...';

                // Put the HTML into the textarea
                document.getElementById('input-data').value = data.html;

                // Automatically parse it
                setTimeout(() => {
                    parseNankanData();
                    statusEl.textContent = '✅ 完了！データを確認してください';
                }, 500);

            } catch (error) {
                console.error('Error fetching race card:', error);
                statusEl.textContent = '❌ エラー: ' + error.message;
            }
        }

        // Parse Nankan Race Card and Auto-Generate Scores
        function parseNankanData() {
            const rawData = document.getElementById('input-data').value;

            if (!rawData.trim()) {
                showStatus('input-status', '⚠️ 南関出馬表データを貼り付けてください', 'error');
                return;
            }

            try {
                const horses = [];

                console.log(`========== データ形式を検出中 ==========`);

                // 貼り付けられたデータの最初の部分を詳細表示
                const lines = rawData.split('\n');
                console.log(`全${lines.length}行`);
                console.log('========== 行78-150を表示（1頭目のデータ） ==========');
                lines.slice(78, 150).forEach((line, i) => {
                    console.log(`行${i + 78}: "${line}"`);
                });

                // HTML形式かどうかチェック
                if (rawData.includes('<td') || rawData.includes('<tr')) {
                    console.log('✅ HTML形式を検出');

                    // DOMParserでHTMLをパース
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(rawData, 'text/html');

                    // すべての<tr>（テーブル行）を取得
                    const rows = doc.querySelectorAll('tr');
                    console.log(`全${rows.length}行のテーブル行を検出`);

                    // rowspan属性を持つ<td>で馬番を探す方法
                    const rowsArray = Array.from(rows);
                    const detectedHorses = [];

                    for (let i = 0; i < rowsArray.length; i++) {
                        const row = rowsArray[i];
                        const cells = row.querySelectorAll('td');

                        // 馬番を検出: <td class="umaban">で1-18の数字
                        let baban = null;
                        let horseName = null;

                        // 方法1: class="umaban"のセルを探す（南関公式サイト形式）
                        const umabanCell = row.querySelector('td.umaban');
                        if (umabanCell) {
                            const num = parseInt(umabanCell.textContent.trim());
                            if (!isNaN(num) && num >= 1 && num <= 18) {
                                baban = num;
                                console.log(`🐴 馬番${baban}を検出（umaban class）`);
                            }
                        }

                        // 方法2（フォールバック）: rowspan属性を持つセルで馬番を探す
                        if (!baban) {
                            for (const cell of cells) {
                                if (cell.hasAttribute('rowspan')) {
                                    const text = cell.textContent.trim();
                                    const num = parseInt(text);
                                    if (!isNaN(num) && num >= 1 && num <= 18) {
                                        baban = num;
                                        console.log(`🐴 馬番${baban}を検出（rowspan）`);
                                        break;
                                    }
                                }
                            }
                        }

                        // 馬名を検出: <a>タグ内の<span class="nk23_u-text16">またはカタカナ3文字以上
                        const links = row.querySelectorAll('a');
                        for (const link of links) {
                            // 方法1: <span class="nk23_u-text16">を探す（南関公式サイト形式）
                            const nameSpan = link.querySelector('span.nk23_u-text16');
                            if (nameSpan) {
                                const text = nameSpan.textContent.trim();
                                if (text.length >= 3) {
                                    horseName = text;
                                    console.log(`  馬名「${horseName}」を検出（nk23_u-text16 span）`);
                                    break;
                                }
                            }

                            // 方法2（フォールバック）: カタカナ3文字以上
                            if (!horseName) {
                                const text = link.textContent.trim();
                                if (/^[ァ-ヶー]{3,}$/.test(text)) {
                                    horseName = text;
                                    console.log(`  馬名「${horseName}」を検出（カタカナパターン）`);
                                    break;
                                }
                            }
                        }

                        // 馬番と馬名が両方見つかった場合、成績データを探す
                        if (baban && horseName) {
                            let statsData = null;

                            // 現在の行と次の20行を検索
                            for (let j = i; j < Math.min(i + 20, rowsArray.length); j++) {
                                const searchRow = rowsArray[j];

                                // 方法1: <td class="is-grnum">内の<span>タグから成績を抽出（南関公式サイト形式）
                                const statsCells = searchRow.querySelectorAll('td.is-grnum');
                                for (const statsCell of statsCells) {
                                    const spans = statsCell.querySelectorAll('span');
                                    if (spans.length >= 4) {
                                        // 最後の<p>内の4つの<span>を取得（全体成績）
                                        const pTag = statsCell.querySelector('p');
                                        if (pTag) {
                                            const statSpans = pTag.querySelectorAll('span');
                                            if (statSpans.length >= 4) {
                                                const w = parseInt(statSpans[0].textContent.trim());
                                                const p = parseInt(statSpans[1].textContent.trim());
                                                const s = parseInt(statSpans[2].textContent.trim());
                                                const r = parseInt(statSpans[3].textContent.trim());

                                                if (!isNaN(w) && !isNaN(p) && !isNaN(s) && !isNaN(r)) {
                                                    const total = w + p + s + r;
                                                    if (total > 0) {
                                                        statsData = {
                                                            w, p, s, r, total,
                                                            winRate: (w / total * 100).toFixed(1),
                                                            placeRate: ((w + p) / total * 100).toFixed(1)
                                                        };
                                                        console.log(`  ✅ 成績データ発見（span方式）: ${w}-${p}-${s}-${r} (行${j})`);
                                                        break;
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }

                                // 方法2（フォールバック）: テキストから正規表現で成績を抽出
                                if (!statsData) {
                                    const searchText = searchRow.textContent;
                                    const statsMatch = searchText.match(/全?\s*(\d+)\s*-\s*(\d+)\s*-\s*(\d+)\s*-\s*(\d+)/);
                                    if (statsMatch) {
                                        const [_, w, p, s, r] = statsMatch;
                                        const total = parseInt(w) + parseInt(p) + parseInt(s) + parseInt(r);
                                        if (total > 0) {
                                            statsData = {
                                                w, p, s, r, total,
                                                winRate: (parseInt(w) / total * 100).toFixed(1),
                                                placeRate: ((parseInt(w) + parseInt(p)) / total * 100).toFixed(1)
                                            };
                                            console.log(`  ✅ 成績データ発見（正規表現）: ${w}-${p}-${s}-${r} (行${j})`);
                                            break;
                                        }
                                    }
                                }

                                if (statsData) break;
                            }

                            // 馬データを追加
                            detectedHorses.push({
                                num: baban,
                                name: horseName,
                                stats: statsData ? {
                                    totalRaces: statsData,
                                    winRate: statsData.winRate,
                                    placeRate: statsData.placeRate,
                                    recentRaces: []
                                } : null
                            });

                            if (statsData) {
                                console.log(`✅ 馬${baban} ${horseName}: 勝率${statsData.winRate}%、連対率${statsData.placeRate}%`);
                            } else {
                                console.log(`⚠️ 馬${baban} ${horseName}: 成績データ未検出（デフォルトスコアを使用）`);
                            }
                        }
                    }

                    // 成績データがある馬のみをhorsesに追加（成績なしの場合はデフォルトスコアを使用）
                    horses.push(...detectedHorses);
                    console.log(`検出した馬: ${horses.length}頭`);
                } else {
                    // CSV形式として処理（後方互換性）
                    console.log('⚠️ HTML形式ではありません。CSV/テキスト形式として処理を試みます');
                    showStatus('input-status', '⚠️ HTML形式を検出できませんでした。ブラウザで出馬表ページを開き、ページ全体を選択してコピーしてください', 'error');
                    return;
                }

                console.log(`最終結果: ${horses.length}頭`, horses);

                if (horses.length === 0) {
                    showStatus('input-status', '⚠️ 馬データを検出できませんでした。出馬表全体をコピーしてください', 'error');
                    return;
                }

                // Auto-calculate scores
                const results = horses.map(horse => {
                    const score = calculateAutoScore(horse.stats);
                    const prob = calculateProbability(score, horses.length);
                    console.log(`${horse.num} ${horse.name}: score=${score}, prob=${prob}%`);
                    return `${horse.num},${horse.name},${score},${prob}%`;
                });

                // レース名を推定（仮に「1R 大井 C3」とする）
                const raceName = "1R 大井 C3（南関出馬表から自動生成）";
                const output = `${raceName}\n${results.join('\n')}`;

                // 自動変換して表示
                document.getElementById('input-data').value = output;
                const converted = smartConvert(output);
                document.getElementById('input-data').value = converted;
                updatePreview();

                showStatus('input-status', `✅ ${horses.length}頭のデータを自動生成しました！`, 'success');
            } catch (error) {
                console.error('Parse error:', error);
                showStatus('input-status', '⚠️ データ解析エラー: ' + error.message, 'error');
            }
        }

        // Calculate Auto Score from stats
        function calculateAutoScore(stats) {
            // デフォルト値チェック
            if (!stats || typeof stats !== 'object') {
                return 7.0;
            }

            let score = 7.0; // Base score

            // Recent form (調子スコア)
            if (stats.recentRaces && stats.recentRaces.length >= 3) {
                const recent3 = stats.recentRaces.slice(0, 3);
                const avgRank = recent3.reduce((a, b) => a + b, 0) / recent3.length;

                // 平均着順が良いほど高スコア
                if (avgRank <= 3) score += 1.5;
                else if (avgRank <= 5) score += 1.0;
                else if (avgRank <= 7) score += 0.5;
                else if (avgRank >= 10) score -= 1.0;

                // 上昇傾向チェック
                if (recent3.length >= 3) {
                    if (recent3[0] < recent3[1] && recent3[1] < recent3[2]) {
                        score += 0.8; // 上昇傾向
                    } else if (recent3[0] > recent3[1] && recent3[1] > recent3[2]) {
                        score -= 0.5; // 下降傾向
                    }
                }
            }

            // Win rate bonus
            if (stats.winRate) {
                const wr = parseFloat(stats.winRate);
                if (wr >= 20) score += 1.5;
                else if (wr >= 10) score += 1.0;
                else if (wr >= 5) score += 0.5;
            }

            // Place rate bonus
            if (stats.placeRate) {
                const pr = parseFloat(stats.placeRate);
                if (pr >= 40) score += 1.0;
                else if (pr >= 25) score += 0.5;
            }

            // 経験値ボーナス
            if (stats.totalRaces && stats.totalRaces.total >= 20) {
                score += 0.3; // ベテランボーナス
            }

            // スコアを0.1刻みに丸める
            score = Math.max(5.0, Math.min(10.0, score)); // 5.0〜10.0の範囲
            return score.toFixed(1);
        }

        // Calculate Probability
        function calculateProbability(score, totalHorses) {
            // スコアベースで確率を計算（単純化）
            const baseProb = 100 / totalHorses;
            const scoreFactor = parseFloat(score) / 7.5; // 7.5を基準
            const prob = baseProb * scoreFactor;
            return Math.max(5, Math.min(60, Math.round(prob))); // 5%〜60%
        }

        // Clear Data
        function clearData() {
            // 入力データとプレビューをクリア
            document.getElementById('input-data').value = '';
            updatePreview();
        }

        // Show Status Message
        function showStatus(elementId, message, type) {
            const statusEl = document.getElementById(elementId);
            statusEl.textContent = message;
            statusEl.className = `status-message ${type}`;

            setTimeout(() => {
                statusEl.className = 'status-message';
            }, 5000);
        }

    </script>
</body>
</html>
