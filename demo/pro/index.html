<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NANKAN Analytics Pro - ãƒ‡ãƒ¢ã‚µã‚¤ãƒˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg-main: #0f172a;
            --bg-card: #1e293b;
            --bg-card-hover: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
            --shadow: rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', Meiryo, sans-serif;
            background: var(--bg-main);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            background: var(--bg-card);
            border-bottom: 2px solid var(--primary);
            padding: 20px 0;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px var(--shadow);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            font-size: 28px;
            color: var(--text-primary);
            font-weight: 700;
        }

        .logo-badge {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }


        /* Admin Panel */
        .admin-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        @media (max-width: 1024px) {
            .admin-panel {
                grid-template-columns: 1fr;
            }
        }

        .panel-section {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px var(--shadow);
        }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 24px;
            background: var(--primary);
            border-radius: 2px;
        }

        textarea {
            width: 100%;
            min-height: 300px;
            padding: 15px;
            background: var(--bg-main);
            color: var(--text-primary);
            border: 2px solid var(--border);
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 14px;
            resize: vertical;
            transition: border-color 0.3s ease;
        }

        textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        button {
            padding: 12px 24px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        button:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
        }

        button:disabled {
            background: var(--border);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: var(--bg-card-hover);
        }

        .btn-secondary:hover {
            background: var(--border);
            box-shadow: 0 4px 12px rgba(51, 65, 85, 0.4);
        }

        .btn-success {
            background: var(--success);
        }

        .btn-success:hover {
            background: #059669;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        /* Status Message */
        .status-message {
            margin-top: 15px;
            padding: 12px 16px;
            border-radius: 8px;
            font-weight: 600;
            display: none;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .status-message.success {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
            border: 1px solid var(--success);
            display: block;
        }

        .status-message.error {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
            border: 1px solid var(--danger);
            display: block;
        }

        /* Preview Area */
        #preview-area {
            min-height: 400px;
            position: relative;
            border: 2px dashed rgba(148, 163, 184, 0.3);
            border-radius: 8px;
            padding: 20px;
            background: var(--bg-main);
        }

        #preview-area::after {
            content: 'ğŸ“‹ ãƒ‡ãƒ¼ã‚¿ç¢ºèªç”¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆç°¡æ˜“è¡¨ç¤ºï¼‰';
            position: absolute;
            top: -12px;
            left: 20px;
            background: var(--bg-card);
            color: var(--text-secondary);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            z-index: 3;
            border: 1px solid rgba(148, 163, 184, 0.3);
        }

        #preview-area > * {
            position: relative;
            z-index: 2;
        }

        /* Preview Simple Table */
        .preview-race {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
        }

        .preview-race-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .preview-table th {
            text-align: left;
            padding: 8px;
            color: var(--text-secondary);
            font-weight: 600;
            background: var(--bg-main);
        }

        .preview-table td {
            padding: 8px;
            color: var(--text-primary);
            border-top: 1px solid var(--border);
        }


        /* Race Card */
        .race-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px var(--shadow);
            border: 1px solid var(--border);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .race-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px var(--shadow);
        }

        .race-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border);
        }

        .race-title {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .race-meta {
            display: flex;
            gap: 15px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Horse Table */
        .horse-table {
            width: 100%;
            border-collapse: collapse;
        }

        .horse-table thead {
            background: var(--bg-main);
        }

        .horse-table th {
            padding: 12px;
            text-align: left;
            font-weight: 700;
            font-size: 13px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .horse-table td {
            padding: 15px 12px;
            border-top: 1px solid var(--border);
        }

        .horse-table tbody tr {
            transition: background 0.2s ease;
        }

        .horse-table tbody tr:hover {
            background: var(--bg-card-hover);
        }

        .rank-badge {
            display: inline-block;
            width: 32px;
            height: 32px;
            line-height: 32px;
            text-align: center;
            border-radius: 50%;
            font-weight: 700;
            font-size: 14px;
        }

        .rank-1 {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: #78350f;
        }

        .rank-2 {
            background: linear-gradient(135deg, #d1d5db, #9ca3af);
            color: #1f2937;
        }

        .rank-3 {
            background: linear-gradient(135deg, #f87171, #dc2626);
            color: white;
        }

        .rank-other {
            background: var(--bg-main);
            color: var(--text-secondary);
        }

        .horse-number {
            font-weight: 700;
            color: var(--text-primary);
            font-size: 16px;
        }

        .horse-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .score-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-main);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }

        .score-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--success));
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .probability {
            font-size: 18px;
            font-weight: 700;
            color: var(--success);
        }

        /* Professional Styles */
        .data-grid {
            overflow-x: auto;
        }

        .analysis-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .analysis-table thead {
            background: var(--bg-main);
        }

        .analysis-table th {
            padding: 12px 10px;
            text-align: center;
            font-weight: 700;
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid var(--border);
        }

        .analysis-table td {
            padding: 14px 10px;
            text-align: center;
            border-bottom: 1px solid var(--border);
        }

        .rank-cell {
            font-weight: 700;
            font-size: 16px;
        }

        .horse-num {
            font-weight: 700;
            color: var(--primary);
            font-size: 15px;
        }

        /* Score Bars */
        .score-cell {
            position: relative;
            padding: 4px;
        }

        .score-value {
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .score-bar-mini {
            width: 100%;
            height: 4px;
            background: var(--bg-main);
            border-radius: 2px;
            overflow: hidden;
        }

        .score-fill-mini {
            height: 100%;
            border-radius: 2px;
            transition: width 0.5s ease;
        }

        .fill-total { background: linear-gradient(90deg, #3b82f6, #06b6d4); }
        .fill-speed { background: linear-gradient(90deg, #10b981, #14b8a6); }
        .fill-stable { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
        .fill-power { background: linear-gradient(90deg, #ef4444, #f97316); }
        .fill-adapt { background: linear-gradient(90deg, #8b5cf6, #a78bfa); }

        .prob-cell {
            font-size: 16px;
            font-weight: 700;
            color: var(--success);
        }

        /* Legend */
        .legend {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            font-size: 11px;
            color: var(--text-secondary);
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend-bar {
            width: 30px;
            height: 4px;
            border-radius: 2px;
        }

        /* Betting Recommendations */
        .betting-section {
            background: var(--bg-main);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid var(--primary);
        }

        .betting-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .betting-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .betting-item {
            background: var(--bg-card);
            padding: 12px 15px;
            border-radius: 6px;
            border: 1px solid var(--border);
        }

        .betting-type {
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .betting-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--success);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-text {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .empty-subtext {
            font-size: 14px;
        }

        /* Footer */
        footer {
            margin-top: 60px;
            padding: 30px 0;
            border-top: 1px solid var(--border);
            text-align: center;
            color: var(--text-secondary);
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 15px;
        }

        .footer-links a {
            color: var(--text-secondary);
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .footer-links a:hover {
            color: var(--primary);
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <h1>ğŸ‡ NANKAN Analytics Pro</h1>
            <div class="logo-badge">Demo System</div>
        </div>
    </header>

    <div class="container">
            <div class="admin-panel">
                <!-- Input Section -->
                <div class="panel-section">
                    <h2 class="section-title">äºˆæƒ³ãƒ‡ãƒ¼ã‚¿å…¥åŠ›</h2>
                    <textarea id="input-data" placeholder="ğŸ’¡ 3ã¤ã®å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œï¼

ã€ğŸ‡ å—é–¢å‡ºé¦¬è¡¨ãƒ¢ãƒ¼ãƒ‰ã€‘â† NEW!
1. å—é–¢ç«¶é¦¬ã®å‡ºé¦¬è¡¨ãƒšãƒ¼ã‚¸å…¨ä½“ã‚’ã‚³ãƒ”ãƒ¼ï¼ˆCtrl+A â†’ Ctrl+Cï¼‰
2. ã“ã“ã«è²¼ã‚Šä»˜ã‘
3. ã€ŒğŸ‡ å—é–¢å‡ºé¦¬è¡¨ã‹ã‚‰è‡ªå‹•ç”Ÿæˆã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
â†’ é¦¬ç•ªãƒ»é¦¬åãƒ»ã‚¹ã‚³ã‚¢ãƒ»ç¢ºç‡ã‚’è‡ªå‹•ç”Ÿæˆï¼

ã€ç°¡æ˜“ç‰ˆã€‘é¦¬ç•ª,é¦¬å,ã‚¹ã‚³ã‚¢,ç¢ºç‡ ã®4é …ç›®ã ã‘ã§OK
ä¾‹ï¼š1,ãƒ›ãƒ¯ã‚¤ãƒˆã‚µãƒ³ã‚º,9.8,45%
ã€€ã€€2,ãƒ–ãƒ©ãƒƒã‚¯ãƒŠã‚¤ãƒˆ,8.2,38%

ã€è©³ç´°ç‰ˆã€‘å…¨ã‚¹ã‚³ã‚¢å…¥åŠ›ï¼ˆ5ã‚¹ã‚³ã‚¢ï¼‰
ä¾‹ï¼š1,ãƒ›ãƒ¯ã‚¤ãƒˆã‚µãƒ³ã‚º,9.8,8.5,7.2,6.8,5.4,45%

ã€Excel/ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰è²¼ã‚Šä»˜ã‘ã‚‚OKã€‘
ã‚¿ãƒ–åŒºåˆ‡ã‚Šãƒ»ã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šã‚‚è‡ªå‹•å¤‰æ›ã•ã‚Œã¾ã™

---ãƒ¬ãƒ¼ã‚¹åŒºåˆ‡ã‚Š / ===è²·ã„ç›®åŒºåˆ‡ã‚Š"></textarea>
                    <div class="button-group">
                        <button onclick="loadSampleData()">
                            ğŸ“‹ ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿
                        </button>
                        <button onclick="parseNankanData()" class="btn-success">
                            ğŸ‡ å—é–¢å‡ºé¦¬è¡¨ã‹ã‚‰è‡ªå‹•ç”Ÿæˆ
                        </button>
                        <button onclick="clearData()" class="btn-secondary">
                            ğŸ—‘ï¸ ã‚¯ãƒªã‚¢
                        </button>
                    </div>
                    <div id="input-status" class="status-message"></div>
                </div>

                <!-- Preview Section -->
                <div class="panel-section">
                    <h2 class="section-title">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
                    <div id="preview-area">
                        <div class="empty-state">
                            <div class="empty-icon">ğŸ“Š</div>
                            <div class="empty-text">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢</div>
                            <div class="empty-subtext">å·¦å´ã«ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€ã“ã“ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
                        </div>
                    </div>
                    <div class="button-group">
                        <button id="publish-btn" onclick="publishToSite()" class="btn-success" disabled>
                            ğŸš€ å…¬é–‹ã‚µã‚¤ãƒˆã«åæ˜ 
                        </button>
                        <button id="open-btn" onclick="window.open('public.html', '_blank')" class="btn-secondary" disabled>
                            ğŸŒ å…¬é–‹ã‚µã‚¤ãƒˆã‚’é–‹ã
                        </button>
                    </div>
                    <div id="preview-status" class="status-message"></div>
                </div>
            </div>
    </div>

    <footer>
        <div class="footer-links">
            <a href="https://github.com/nankan-analytics-pro">GitHub</a>
            <a href="#">ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ</a>
            <a href="#">ãŠå•ã„åˆã‚ã›</a>
        </div>
        <p>&copy; 2025 NANKAN Analytics Pro. All rights reserved.</p>
    </footer>

    <script>
        // Smart Auto-Convert Function
        function smartConvert(text) {
            const lines = text.split('\n');
            const converted = lines.map(line => {
                // Skip empty lines, headers, separators, and betting data
                if (!line.trim() || line.includes('R ') || line.trim() === '---' || line.trim() === '===' || line.includes(':')) {
                    return line;
                }

                // Detect delimiter (tab or multiple spaces)
                let parts;
                if (line.includes('\t')) {
                    parts = line.split('\t').map(p => p.trim()).filter(p => p);
                } else if (line.match(/\s{2,}/)) {
                    parts = line.split(/\s+/).map(p => p.trim()).filter(p => p);
                } else if (line.includes(',')) {
                    parts = line.split(',').map(p => p.trim()).filter(p => p);
                } else {
                    return line; // No delimiter found
                }

                // If already has 7+ parts, it's complete
                if (parts.length >= 7) {
                    return parts.join(',');
                }

                // Simple mode: 4 parts (num, name, score, prob)
                if (parts.length === 4) {
                    const [num, name, mainScore, prob] = parts;
                    const score = parseFloat(mainScore);

                    // Auto-generate 4 sub-scores based on main score
                    const score2 = (score - 0.3 - Math.random() * 0.4).toFixed(1);
                    const score3 = (score - 0.6 - Math.random() * 0.6).toFixed(1);
                    const score4 = (score - 1.0 - Math.random() * 0.8).toFixed(1);
                    const score5 = (score - 1.5 - Math.random() * 1.0).toFixed(1);

                    return `${num},${name},${mainScore},${score2},${score3},${score4},${score5},${prob}`;
                }

                // Return as-is if format is unexpected
                return parts.join(',');
            });

            return converted.join('\n');
        }

        // Auto-convert on paste
        const inputData = document.getElementById('input-data');
        inputData.addEventListener('paste', function(e) {
            setTimeout(() => {
                const converted = smartConvert(this.value);
                if (converted !== this.value) {
                    this.value = converted;
                    updatePreview();
                }
            }, 10);
        });

        // Auto-preview on input
        let debounceTimer;
        inputData.addEventListener('input', function() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                updatePreview();
            }, 500);
        });

        // Update Preview (Simple view for data confirmation)
        function updatePreview() {
            const inputData = document.getElementById('input-data').value.trim();
            const previewArea = document.getElementById('preview-area');
            const publishBtn = document.getElementById('publish-btn');

            if (!inputData) {
                previewArea.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“Š</div>
                        <div class="empty-text">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢</div>
                        <div class="empty-subtext">å·¦å´ã«ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€ã“ã“ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
                    </div>
                `;
                publishBtn.disabled = true;
                return;
            }

            try {
                const html = convertToSimplePreview(inputData);
                previewArea.innerHTML = html;
                publishBtn.disabled = false;
                showStatus('input-status', 'ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ', 'success');
            } catch (error) {
                previewArea.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">âš ï¸</div>
                        <div class="empty-text">ã‚¨ãƒ©ãƒ¼</div>
                        <div class="empty-subtext">${error.message}</div>
                    </div>
                `;
                publishBtn.disabled = true;
                showStatus('input-status', 'ãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“', 'error');
            }
        }

        // Convert to Simple Preview (Plain table format)
        function convertToSimplePreview(data) {
            const races = data.split('---').map(r => r.trim()).filter(r => r);
            let html = '';

            races.forEach((race, idx) => {
                const lines = race.split('\n').filter(l => l.trim());
                if (lines.length < 2) return;

                const header = lines[0];
                const horses = lines.slice(1);

                html += `
                    <div class="preview-race">
                        <div class="preview-race-title">${header}</div>
                        <table class="preview-table">
                            <thead>
                                <tr>
                                    <th>é¦¬ç•ª</th>
                                    <th>é¦¬å</th>
                                    <th>ã‚¹ã‚³ã‚¢</th>
                                    <th>ç¢ºç‡</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                horses.forEach((horse, i) => {
                    const parts = horse.split(',');
                    if (parts.length < 7) return;

                    const [num, name, score1, score2, score3, score4, score5, prob] = parts;

                    html += `
                        <tr>
                            <td>${num}</td>
                            <td>${name}</td>
                            <td>${score1}</td>
                            <td>${prob}</td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            });

            return html || '<div class="empty-state"><div class="empty-icon">âš ï¸</div><div class="empty-text">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div></div>';
        }

        // Convert data to Professional HTML
        function convertToHTML(data) {
            const races = data.split('---').map(r => r.trim()).filter(r => r);
            let html = '';

            races.forEach((race, idx) => {
                // è²·ã„ç›®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’åˆ†é›¢
                const parts = race.split('===');
                const horseData = parts[0].trim();
                const bettingData = parts[1] ? parts[1].trim() : '';

                const lines = horseData.split('\n').filter(l => l.trim());
                if (lines.length < 2) return;

                const header = lines[0];
                const horses = lines.slice(1);

                html += `
                    <div class="race-card">
                        <div class="race-header">
                            <div class="race-title">${header}</div>
                            <div class="race-meta">
                                <div>ğŸ‡ ${horses.length}é ­ç«‹ã¦</div>
                                <div>ğŸ“… ${new Date().toLocaleDateString('ja-JP')}</div>
                                <div>â° ${new Date().toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'})}</div>
                            </div>
                        </div>

                        <div class="legend">
                            <div class="legend-item">
                                <div class="legend-bar fill-total"></div>
                                <span>ç·åˆè©•ä¾¡</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-bar fill-speed"></div>
                                <span>ã‚¹ãƒ”ãƒ¼ãƒ‰æŒ‡æ•°</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-bar fill-stable"></div>
                                <span>å®‰å®šæ€§</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-bar fill-power"></div>
                                <span>åœ°åŠ›</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-bar fill-adapt"></div>
                                <span>é©æ€§</span>
                            </div>
                        </div>

                        <div class="data-grid">
                            <table class="analysis-table">
                                <thead>
                                    <tr>
                                        <th>é †ä½</th>
                                        <th>é¦¬ç•ª</th>
                                        <th style="text-align: left;">é¦¬å</th>
                                        <th>ç·åˆ</th>
                                        <th>ã‚¹ãƒ”ãƒ¼ãƒ‰</th>
                                        <th>å®‰å®šæ€§</th>
                                        <th>åœ°åŠ›</th>
                                        <th>é©æ€§</th>
                                        <th>çš„ä¸­ç‡</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;

                horses.forEach((horse, i) => {
                    const parts = horse.split(',');
                    if (parts.length < 7) return;

                    const [num, name, score1, score2, score3, score4, score5, prob] = parts;
                    const rankClass = i === 0 ? 'rank-1' : i === 1 ? 'rank-2' : i === 2 ? 'rank-3' : '';

                    html += `
                        <tr>
                            <td class="rank-cell ${rankClass}">${i + 1}</td>
                            <td class="horse-num">${num}</td>
                            <td class="horse-name">${name}</td>
                            <td class="score-cell">
                                <div class="score-value">${score1}</div>
                                <div class="score-bar-mini">
                                    <div class="score-fill-mini fill-total" style="width: ${score1 * 10}%"></div>
                                </div>
                            </td>
                            <td class="score-cell">
                                <div class="score-value">${score2}</div>
                                <div class="score-bar-mini">
                                    <div class="score-fill-mini fill-speed" style="width: ${score2 * 10}%"></div>
                                </div>
                            </td>
                            <td class="score-cell">
                                <div class="score-value">${score3}</div>
                                <div class="score-bar-mini">
                                    <div class="score-fill-mini fill-stable" style="width: ${score3 * 10}%"></div>
                                </div>
                            </td>
                            <td class="score-cell">
                                <div class="score-value">${score4}</div>
                                <div class="score-bar-mini">
                                    <div class="score-fill-mini fill-power" style="width: ${score4 * 10}%"></div>
                                </div>
                            </td>
                            <td class="score-cell">
                                <div class="score-value">${score5}</div>
                                <div class="score-bar-mini">
                                    <div class="score-fill-mini fill-adapt" style="width: ${score5 * 10}%"></div>
                                </div>
                            </td>
                            <td class="prob-cell">${prob}</td>
                        </tr>
                    `;
                });

                html += `
                                </tbody>
                            </table>
                        </div>
                `;

                // è²·ã„ç›®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
                if (bettingData) {
                    const bettingLines = bettingData.split('\n').filter(l => l.trim());
                    const bettings = {};

                    bettingLines.forEach(line => {
                        const [type, value] = line.split(':').map(s => s.trim());
                        if (type && value) {
                            bettings[type] = value;
                        }
                    });

                    html += `
                        <div class="betting-section">
                            <div class="betting-title">ğŸ“‹ æ¨å¥¨è²·ã„ç›®</div>
                            <div class="betting-grid">
                    `;

                    if (bettings['å˜å‹']) {
                        html += `
                            <div class="betting-item">
                                <div class="betting-type">å˜å‹</div>
                                <div class="betting-value">${bettings['å˜å‹']}ç•ª</div>
                            </div>
                        `;
                    }

                    if (bettings['é¦¬å˜']) {
                        html += `
                            <div class="betting-item">
                                <div class="betting-type">é¦¬å˜</div>
                                <div class="betting-value">${bettings['é¦¬å˜'].replace('-', ' â†’ ')}</div>
                            </div>
                        `;
                    }

                    if (bettings['ä¸‰é€£å˜']) {
                        html += `
                            <div class="betting-item">
                                <div class="betting-type">ä¸‰é€£å˜</div>
                                <div class="betting-value">${bettings['ä¸‰é€£å˜'].replace(/-/g, ' â†’ ')}</div>
                            </div>
                        `;
                    }

                    if (bettings['ä¸‰é€£è¤‡']) {
                        html += `
                            <div class="betting-item">
                                <div class="betting-type">ä¸‰é€£è¤‡</div>
                                <div class="betting-value">${bettings['ä¸‰é€£è¤‡'].replace(/-/g, ' - ')}</div>
                            </div>
                        `;
                    }

                    html += `
                            </div>
                        </div>
                    `;
                }

                html += `
                    </div>
                `;
            });

            return html || '<div class="empty-state"><div class="empty-icon">âš ï¸</div><div class="empty-text">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div></div>';
        }

        // Publish to Site
        function publishToSite() {
            const inputData = document.getElementById('input-data').value.trim();

            // å…ƒã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ãƒªãƒƒãƒãªHTMLã‚’ç”Ÿæˆ
            const richHTML = convertToHTML(inputData);

            // LocalStorageã«ä¿å­˜
            localStorage.setItem('nankan-pro-data', richHTML);

            // å…¬é–‹ã‚µã‚¤ãƒˆã‚’é–‹ããƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
            document.getElementById('open-btn').disabled = false;

            showStatus('preview-status', 'âœ… å…¬é–‹ã‚µã‚¤ãƒˆã«åæ˜ ã—ã¾ã—ãŸï¼ã€Œå…¬é–‹ã‚µã‚¤ãƒˆã‚’é–‹ãã€ãƒœã‚¿ãƒ³ã§ç¢ºèªã§ãã¾ã™', 'success');
        }

        // Load Sample Data
        function loadSampleData() {
            const sampleData = `5R é–€åˆ¥ ã‚µãƒ©ç³»3æ­³
1,ãƒ›ãƒ¯ã‚¤ãƒˆã‚µãƒ³ã‚º,9.8,45%
2,ãƒ–ãƒ©ãƒƒã‚¯ãƒŠã‚¤ãƒˆ,8.2,38%
3,ãƒ¬ãƒƒãƒ‰ãƒ•ãƒ¬ã‚¤ãƒ ,7.9,35%
4,ã‚°ãƒªãƒ¼ãƒ³ãƒ•ã‚©ãƒ¬ã‚¹ãƒˆ,7.2,28%
5,ãƒ–ãƒ«ãƒ¼ã‚ªãƒ¼ã‚·ãƒ£ãƒ³,6.8,24%
===
å˜å‹:1
é¦¬å˜:1-2
ä¸‰é€£å˜:1-2-3
---
8R ç››å²¡ ã‚µãƒ©ç³»3æ­³ä»¥ä¸Š
1,ã‚¹ã‚¿ãƒ¼ãƒ©ã‚¤ãƒˆ,9.2,42%
2,ãƒ ãƒ¼ãƒ³ã‚·ãƒ£ãƒ‰ã‚¦,8.5,39%
3,ã‚µãƒ³ãƒ©ã‚¤ã‚º,8.0,36%
4,ãƒŸãƒƒãƒ‰ãƒŠã‚¤ãƒˆ,7.5,32%
5,ãƒ€ã‚¹ã‚¯,7.0,29%
===
å˜å‹:1
é¦¬å˜:1-2
ä¸‰é€£å˜:1-2-4
ä¸‰é€£è¤‡:1-2-3`;

            document.getElementById('input-data').value = sampleData;
            // Auto-convert to full format
            const converted = smartConvert(sampleData);
            document.getElementById('input-data').value = converted;
            updatePreview();
        }

        // Parse Nankan Race Card and Auto-Generate Scores
        function parseNankanData() {
            const rawData = document.getElementById('input-data').value;

            if (!rawData.trim()) {
                showStatus('input-status', 'âš ï¸ å—é–¢å‡ºé¦¬è¡¨ãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„', 'error');
                return;
            }

            try {
                // Parse horse data from complex format
                const horses = [];
                const lines = rawData.split('\n');

                let currentHorse = null;
                let horseNum = null;
                let horseName = null;

                console.log(`========== å…¨${lines.length}è¡Œã‚’ãƒ‘ãƒ¼ã‚¹é–‹å§‹ ==========`);

                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();

                    // ç©ºè¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—
                    if (!line) continue;

                    // æœ€åˆã®10è¡Œã¯ç”Ÿã®å†…å®¹ã‚’è¡¨ç¤º
                    if (i < 10) {
                        console.log(`è¡Œ${i}: "${line.substring(0, 50)}" (é•·ã•${line.length})`);
                    }

                    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—
                    if (line.includes('æ ç•ª') || line.includes('ç«¶èµ°é¦¬') || line.includes('é¨æ‰‹ãƒ»èª¿æ•™å¸«')) {
                        console.log('ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—:', line.substring(0, 50));
                        continue;
                    }

                    // é¦¬ç•ªã¨é¦¬åã‚’æ¤œå‡ºï¼ˆä¾‹: "1     1     ãƒ†ãƒ«ã‚±ãƒ³ãƒ¦ãƒŸã‚«ãƒ–ãƒˆ     æ–°åŸå‘¨ï¼ˆå·å´ï¼‰"ï¼‰
                    const horseMatch = line.match(/^(\d+)\s+(\d+)\s+(.+)/);
                    if (horseMatch) {
                        const waku = parseInt(horseMatch[1]);
                        const baban = parseInt(horseMatch[2]);

                        console.log(`é¦¬å€™è£œ: æ ${waku} é¦¬ç•ª${baban} "${horseMatch[3].substring(0, 30)}"`);

                        // æ ç•ªã¨é¦¬ç•ªãŒä¸€è‡´ã€ã‹ã¤1-18ã®ç¯„å›²å†…
                        if (waku === baban && waku >= 1 && waku <= 18) {
                            // å‰ã®é¦¬ã‚’ä¿å­˜ï¼ˆæˆç¸¾ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã®ã¿ï¼‰
                            if (currentHorse && horseNum && horseName) {
                                if (currentHorse.totalRaces) {
                                    console.log(`âœ… é¦¬ã‚’ä¿å­˜: ${horseNum} ${horseName}`, currentHorse.totalRaces);
                                    horses.push({num: horseNum, name: horseName, stats: currentHorse});
                                } else {
                                    console.log(`âš ï¸ æˆç¸¾ãƒ‡ãƒ¼ã‚¿ãªã—: ${horseNum} ${horseName}`);
                                }
                            }

                            horseNum = horseMatch[2];
                            // é¦¬åã¯3ç•ªç›®ã®è¦ç´ ã®æœ€åˆã®å˜èªï¼ˆã‚«ã‚¿ã‚«ãƒŠã®ã¿æŠ½å‡ºï¼‰
                            const nameMatch = horseMatch[3].match(/([ã‚¡-ãƒ¶ãƒ¼]+)/);
                            horseName = nameMatch ? nameMatch[1] : horseMatch[3].trim().split(/\s+/)[0];
                            console.log(`ğŸ´ æ–°ã—ã„é¦¬: ${horseNum} ${horseName}`);
                            currentHorse = {
                                distance: {},
                                track: {},
                                surface: {},
                                recentRaces: []
                            };
                            continue;
                        }
                    }

                    // è·é›¢åˆ¥æˆç¸¾ã‚’æ¤œå‡ºï¼ˆä¾‹: "å¤§1459è‰¯ãƒ€ 6"ï¼‰
                    if (line.includes('ãƒ€') && /\d{4}/.test(line)) {
                        const distMatch = line.match(/(\d{4})/);
                        if (distMatch && currentHorse) {
                            const dist = distMatch[1];
                            currentHorse.distance[dist] = line;
                        }
                    }

                    // æˆç¸¾ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œå‡ºï¼ˆä¾‹: "å…¨       1-     0-     0-     9"ï¼‰
                    if (line.includes('å…¨')) {
                        console.log('ğŸ” ã€Œå…¨ã€ã‚’å«ã‚€è¡Œ:', line);
                        if (currentHorse) {
                            console.log('  â†’ currentHorseã‚ã‚Šã€æˆç¸¾ãƒ‘ãƒ¼ã‚¹è©¦è¡Œ');
                            const statsMatch = line.match(/å…¨\s+(\d+)-\s+(\d+)-\s+(\d+)-\s+(\d+)/);
                            if (statsMatch) {
                                const [_, w, p, s, r] = statsMatch;
                                const total = parseInt(w) + parseInt(p) + parseInt(s) + parseInt(r);
                                console.log(`  âœ… æˆç¸¾æ¤œå‡º: ${w}-${p}-${s}-${r} (åˆè¨ˆ${total})`);
                                if (total > 0 && !currentHorse.totalRaces) {
                                    currentHorse.totalRaces = {w, p, s, r, total};
                                    currentHorse.winRate = (parseInt(w) / total * 100).toFixed(1);
                                    currentHorse.placeRate = ((parseInt(w) + parseInt(p)) / total * 100).toFixed(1);
                                    console.log(`  âœ… æˆç¸¾ä¿å­˜: å‹ç‡${currentHorse.winRate}% é€£å¯¾ç‡${currentHorse.placeRate}%`);
                                }
                            } else {
                                console.log('  âš ï¸ æ­£è¦è¡¨ç¾ãƒãƒƒãƒå¤±æ•—:', line.substring(0, 100));
                            }
                        } else {
                            console.log('  âš ï¸ currentHorseæœªè¨­å®š');
                        }
                    }

                    // ç›´è¿‘ç€é †ã‚’æ¤œå‡ºï¼ˆä¾‹: "9 25.10.06ã€€è‰¯ã€€12é ­"ï¼‰
                    const raceMatch = line.match(/^(\d+)\s+\d{2}\.\d{2}\.\d{2}/);
                    if (raceMatch && currentHorse) {
                        const rank = parseInt(raceMatch[1]);
                        // ç€é †ã¯1-18ã®ç¯„å›²å†…ã¨æƒ³å®š
                        if (rank >= 1 && rank <= 18) {
                            currentHorse.recentRaces.push(rank);
                            console.log(`ğŸ ç›´è¿‘ç€é †è¿½åŠ : ${rank}ç€`);
                        }
                    }
                }

                // æœ€å¾Œã®é¦¬ã‚’è¿½åŠ ï¼ˆæˆç¸¾ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã®ã¿ï¼‰
                if (currentHorse && horseNum && horseName) {
                    if (currentHorse.totalRaces) {
                        console.log(`âœ… æœ€å¾Œã®é¦¬ã‚’ä¿å­˜: ${horseNum} ${horseName}`, currentHorse.totalRaces);
                        horses.push({num: horseNum, name: horseName, stats: currentHorse});
                    } else {
                        console.log(`âš ï¸ æœ€å¾Œã®é¦¬ã¯æˆç¸¾ãƒ‡ãƒ¼ã‚¿ãªã—: ${horseNum} ${horseName}`);
                    }
                }

                console.log(`æ¤œå‡ºã—ãŸé¦¬: ${horses.length}é ­`, horses);

                if (horses.length === 0) {
                    showStatus('input-status', 'âš ï¸ é¦¬ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œå‡ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚å‡ºé¦¬è¡¨å…¨ä½“ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„', 'error');
                    return;
                }

                // Auto-calculate scores
                const results = horses.map(horse => {
                    const score = calculateAutoScore(horse.stats);
                    const prob = calculateProbability(score, horses.length);
                    console.log(`${horse.num} ${horse.name}: score=${score}, prob=${prob}%`);
                    return `${horse.num},${horse.name},${score},${prob}%`;
                });

                // ãƒ¬ãƒ¼ã‚¹åã‚’æ¨å®šï¼ˆä»®ã«ã€Œ1R å¤§äº• C3ã€ã¨ã™ã‚‹ï¼‰
                const raceName = "1R å¤§äº• C3ï¼ˆå—é–¢å‡ºé¦¬è¡¨ã‹ã‚‰è‡ªå‹•ç”Ÿæˆï¼‰";
                const output = `${raceName}\n${results.join('\n')}`;

                // è‡ªå‹•å¤‰æ›ã—ã¦è¡¨ç¤º
                document.getElementById('input-data').value = output;
                const converted = smartConvert(output);
                document.getElementById('input-data').value = converted;
                updatePreview();

                showStatus('input-status', `âœ… ${horses.length}é ­ã®ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã—ãŸï¼`, 'success');
            } catch (error) {
                console.error('Parse error:', error);
                showStatus('input-status', 'âš ï¸ ãƒ‡ãƒ¼ã‚¿è§£æã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        }

        // Calculate Auto Score from stats
        function calculateAutoScore(stats) {
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ãƒã‚§ãƒƒã‚¯
            if (!stats || typeof stats !== 'object') {
                return 7.0;
            }

            let score = 7.0; // Base score

            // Recent form (èª¿å­ã‚¹ã‚³ã‚¢)
            if (stats.recentRaces && stats.recentRaces.length >= 3) {
                const recent3 = stats.recentRaces.slice(0, 3);
                const avgRank = recent3.reduce((a, b) => a + b, 0) / recent3.length;

                // å¹³å‡ç€é †ãŒè‰¯ã„ã»ã©é«˜ã‚¹ã‚³ã‚¢
                if (avgRank <= 3) score += 1.5;
                else if (avgRank <= 5) score += 1.0;
                else if (avgRank <= 7) score += 0.5;
                else if (avgRank >= 10) score -= 1.0;

                // ä¸Šæ˜‡å‚¾å‘ãƒã‚§ãƒƒã‚¯
                if (recent3.length >= 3) {
                    if (recent3[0] < recent3[1] && recent3[1] < recent3[2]) {
                        score += 0.8; // ä¸Šæ˜‡å‚¾å‘
                    } else if (recent3[0] > recent3[1] && recent3[1] > recent3[2]) {
                        score -= 0.5; // ä¸‹é™å‚¾å‘
                    }
                }
            }

            // Win rate bonus
            if (stats.winRate) {
                const wr = parseFloat(stats.winRate);
                if (wr >= 20) score += 1.5;
                else if (wr >= 10) score += 1.0;
                else if (wr >= 5) score += 0.5;
            }

            // Place rate bonus
            if (stats.placeRate) {
                const pr = parseFloat(stats.placeRate);
                if (pr >= 40) score += 1.0;
                else if (pr >= 25) score += 0.5;
            }

            // çµŒé¨“å€¤ãƒœãƒ¼ãƒŠã‚¹
            if (stats.totalRaces && stats.totalRaces.total >= 20) {
                score += 0.3; // ãƒ™ãƒ†ãƒ©ãƒ³ãƒœãƒ¼ãƒŠã‚¹
            }

            // ã‚¹ã‚³ã‚¢ã‚’0.1åˆ»ã¿ã«ä¸¸ã‚ã‚‹
            score = Math.max(5.0, Math.min(10.0, score)); // 5.0ã€œ10.0ã®ç¯„å›²
            return score.toFixed(1);
        }

        // Calculate Probability
        function calculateProbability(score, totalHorses) {
            // ã‚¹ã‚³ã‚¢ãƒ™ãƒ¼ã‚¹ã§ç¢ºç‡ã‚’è¨ˆç®—ï¼ˆå˜ç´”åŒ–ï¼‰
            const baseProb = 100 / totalHorses;
            const scoreFactor = parseFloat(score) / 7.5; // 7.5ã‚’åŸºæº–
            const prob = baseProb * scoreFactor;
            return Math.max(5, Math.min(60, Math.round(prob))); // 5%ã€œ60%
        }

        // Clear Data
        function clearData() {
            // å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã‚¯ãƒªã‚¢
            document.getElementById('input-data').value = '';
            updatePreview();
        }

        // Show Status Message
        function showStatus(elementId, message, type) {
            const statusEl = document.getElementById(elementId);
            statusEl.textContent = message;
            statusEl.className = `status-message ${type}`;

            setTimeout(() => {
                statusEl.className = 'status-message';
            }, 5000);
        }

    </script>
</body>
</html>
