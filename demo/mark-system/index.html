<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NANKAN å°è©•ä¾¡ã‚·ã‚¹ãƒ†ãƒ  Pro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Kaku Gothic ProN', 'Yu Gothic', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px 30px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 28px;
            color: #1e3c72;
            margin-bottom: 8px;
        }

        .header p {
            color: #666;
            font-size: 14px;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .panel-title {
            font-size: 20px;
            font-weight: bold;
            color: #1e3c72;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 3px solid #4CAF50;
        }

        textarea {
            width: 100%;
            min-height: 300px;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
            transition: border-color 0.3s;
        }

        textarea:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin: 10px 5px 0 0;
        }

        .button-primary {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
        }

        .button-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }

        .button-secondary {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
        }

        .button-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
        }

        .classification-panel {
            margin-top: 20px;
        }

        .horse-category {
            margin-bottom: 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #f9f9f9;
        }

        .category-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
            font-weight: bold;
            font-size: 16px;
        }

        .category-icon {
            font-size: 24px;
        }

        .horse-tag {
            display: inline-block;
            background: white;
            border: 2px solid #ddd;
            border-radius: 20px;
            padding: 8px 15px;
            margin: 5px;
            cursor: move;
            transition: all 0.3s;
            font-size: 14px;
            position: relative;
        }

        .horse-tag:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            border-color: #4CAF50;
        }

        .horse-tag.dragging {
            opacity: 0.5;
            transform: scale(1.05);
        }

        .horse-tag .category-select {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 2px solid #4CAF50;
            border-radius: 8px;
            padding: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            min-width: 120px;
            display: none;
        }

        .horse-tag .category-select.active {
            display: block;
        }

        .horse-tag .category-option {
            padding: 6px 12px;
            cursor: pointer;
            border-radius: 4px;
            margin: 2px 0;
        }

        .horse-tag .category-option:hover {
            background: #f0f0f0;
        }

        .horse-category.drag-over {
            background: #e8f5e9;
            border-color: #4CAF50;
        }

        .comment-select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            margin-top: 8px;
            background: white;
        }

        .comment-select:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .betting-output {
            background: #1e1e1e;
            color: #f0f0f0;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.8;
            white-space: pre-wrap;
            max-height: 600px;
            overflow-y: auto;
        }

        .status-message {
            padding: 12px 20px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .checkbox-option {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 8px 0;
        }

        .checkbox-option input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-option label {
            cursor: pointer;
            font-size: 14px;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ‡ NANKAN å°è©•ä¾¡ã‚·ã‚¹ãƒ†ãƒ  Pro</h1>
            <p>å°ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è‡ªå‹•ã§äºˆæƒ³ãƒ»è²·ã„ç›®ã‚’ç”Ÿæˆã—ã¾ã™</p>
        </div>

        <div class="main-grid">
            <!-- å·¦å´: å…¥åŠ›ã‚¨ãƒªã‚¢ -->
            <div class="panel">
                <div class="panel-title">ğŸ“‹ äºˆæƒ³ãƒ‡ãƒ¼ã‚¿å…¥åŠ›</div>

                <textarea id="input-data" placeholder="ä¾‹:
å¤§äº•1R ï¼“æ­³(ä¸‰)(å››)ãƒ€1,600mï¼ˆ12é ­ï¼‰ ç™ºèµ°æ™‚åˆ»14:30
1    â—â–³â—‹â–³    ãƒãƒªã‚¢ã‚·ã‚ªãƒ³
2    â–³â–³â—    ã‚¬ãƒ³ãƒŠãƒ¼ãƒ«
3    â—‹â—â–³â—‹    ã‚µãƒ«ã‚¸ãƒ¥
4    â–²    ãƒ”ãƒ¼ã‚¹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
5    â–³â–³â–²â–²    ãƒˆãƒ¼ã‚»ãƒ³ã‚¢ã‚·ãƒ¥ãƒªãƒ¼
6        ã‚¤ã‚µã‚´ãƒ¼ãƒ«ãƒ‰
7    â–²â–³    ã‚³ãƒ‘ã‚«ãƒãƒ¼ãƒŠ
8    â–²â–³â–³    ãƒã‚¸ã‚«ãƒ«ãƒ¬ã‚¤ãƒ³ãƒœãƒ¼
9        ãƒ¬ã‚¤ãƒ´ãƒ³ãƒã‚¹ã‚¿ãƒ¼
10    â–²â—‹â—â–³    ãƒŸãƒ¦ãƒ³ã‚¬ãƒ¼
11    â–³â–²â–²    ãƒãƒƒã‚¯ãƒ«ãƒ™ãƒªãƒ¼
12    â–³â–³    ãƒœãƒ³ãƒãƒ†ã‚£"></textarea>

                <button class="button button-primary" onclick="autoClassify()">ğŸ”„ è‡ªå‹•åˆ†é¡</button>
                <button class="button button-secondary" onclick="loadSampleData()">ğŸ“‹ ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿</button>
                <button class="button button-secondary" onclick="saveData()">ğŸ’¾ ä¿å­˜</button>
                <button class="button button-secondary" onclick="loadData()">ğŸ“‚ èª­è¾¼</button>
                <button class="button button-secondary" onclick="clearAll()">ğŸ—‘ï¸ ã‚¯ãƒªã‚¢</button>

                <div id="status-message"></div>
            </div>

            <!-- å³å´: åˆ†é¡çµæœ -->
            <div class="panel">
                <div class="panel-title">ğŸ¯ åˆ†é¡çµæœãƒ»ç·¨é›†</div>

                <div class="classification-panel" id="classification-panel">
                    <p style="color: #999; text-align: center; padding: 40px;">ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ã€Œè‡ªå‹•åˆ†é¡ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</p>
                </div>

                <button class="button button-primary" onclick="generateBetting()" style="width: 100%; margin-top: 20px;">ğŸ’° è²·ã„ç›®ç”Ÿæˆ</button>
            </div>
        </div>

        <!-- è²·ã„ç›®å‡ºåŠ›ã‚¨ãƒªã‚¢ -->
        <div class="panel" style="margin-top: 20px;" id="betting-panel" hidden>
            <div class="panel-title">ğŸ’° æ¨å¥¨è²·ã„ç›®</div>
            <div class="betting-output" id="betting-output"></div>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let raceData = {
            raceName: '',
            horses: [],
            classification: {
                honmei: null,
                taiko: null,
                tanana: [],
                renka: [],
                osae: [],
                excluded: []
            },
            comments: {
                honmei: '',
                taiko: ''
            }
        };

        // å®šå‹ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆ20å€‹ï¼‰
        const PRESET_COMMENTS = [
            'å‰èµ°ã§å¥½èµ°ã—ã¦ãŠã‚Šã€å‹¢ã„ã«ä¹—ã£ã¦ã„ã‚‹ã€‚ä»Šå›ã‚‚åŒã˜èª¿å­ãªã‚‰å¥½å‹è² ãŒæœŸå¾…ã§ãã‚‹',
            'é€£å‹ä¸­ã§æ³¢ã«ä¹—ã£ã¦ãŠã‚Šã€ã“ã®ã¾ã¾é€£å‹è¡—é“ã‚’çªãé€²ã‚€å¯èƒ½æ€§ãŒé«˜ã„',
            'å‰èµ°ã¯æƒœæ•—ã ã£ãŸãŒå†…å®¹ã¯æ‚ªããªã„ã€‚ä»Šå›ã¯å·»ãè¿”ã—ãŒååˆ†ã«æœŸå¾…ã§ãã‚‹',
            'ä¼‘ã¿æ˜ã‘ã«ã‚‚ã‹ã‹ã‚ã‚‰ãšä»•ä¸ŠãŒã‚Šã¯è‰¯å¥½ã€‚èª¿æ•™ã®å‹•ãã‚‚ç”³ã—åˆ†ãªãä¿¡é ¼ã§ãã‚‹',
            'æŠœç¾¤ã®å®‰å®šæ„Ÿã‚’èª‡ã‚Šã€å¤§å´©ã‚Œã®å¿ƒé…ãŒå°‘ãªã„ã€‚å …å®Ÿã«é¦¬åˆ¸ã«çµ¡ã‚“ã§ãã‚‹ã‚¿ã‚¤ãƒ—',
            'ã“ã“æ•°æˆ¦ã¯å†…å®¹ãŒå……å®Ÿã—ã¦ãŠã‚Šã€ä¸Šæ˜‡ãƒ ãƒ¼ãƒ‰ãŒæ¼‚ã£ã¦ã„ã‚‹ã€‚ä»Šå›ã‚‚æœŸå¾…å¤§',
            'è·é›¢é©æ€§ã¯â—ã§ã€ã“ã®æ¡ä»¶ãªã‚‰åŠ›ã‚’å­˜åˆ†ã«ç™ºæ®ã§ãã‚‹ã€‚ä¿¡é ¼åº¦ã¯é«˜ã„',
            'é¦¬å ´é©æ€§ãŒæŠœç¾¤ã§ã€ç¾åœ¨ã®é¦¬å ´çŠ¶æ…‹ãªã‚‰æœ‰åˆ©ã«ç«‹ã¡å›ã‚Œã‚‹',
            'ã‚³ãƒ¼ã‚¹å®Ÿç¸¾ãŒè±Šå¯Œã§ã€ã“ã®ã‚³ãƒ¼ã‚¹ã‚’ç†ŸçŸ¥ã—ã¦ã„ã‚‹ã€‚åœ°ã®åˆ©ã¯å¤§ãã„',
            'æ é †ã«æµã¾ã‚Œã¦ãŠã‚Šã€ç†æƒ³çš„ãªãƒã‚¸ã‚·ãƒ§ãƒ³ã‹ã‚‰ç«¶é¦¬ãŒã§ãã‚‹',
            'å†…æ ã‚’å¼•ã„ãŸã“ã¨ã§æœ‰åˆ©ãªå±•é–‹ãŒäºˆæƒ³ã•ã‚Œã‚‹ã€‚ã“ã®åˆ©ã‚’ç”Ÿã‹ã—ãŸã„',
            'é¨æ‰‹ãŒå¤‰æ›´ã«ãªã£ãŸã“ã¨ãŒãƒ—ãƒ©ã‚¹ææ–™ã€‚æ–°éä¸Šã¨ã®ç›¸æ€§ã«æœŸå¾…ãŒã‹ã‹ã‚‹',
            'æ‰‹ç¶±ã‚’å–ã‚‹é¨æ‰‹ã®å¥½é¨ä¹—ã«æœŸå¾…ã€‚è…•ã®è¦‹ã›æ‰€ã¨ãªã‚‹ä¸€æˆ¦',
            'é™£å–¶ãŒæœ¬æ°—ã§è‡¨ã‚€ä¸€æˆ¦ã€‚æ°—åˆã®å…¥ã‚Œæ–¹ã‹ã‚‰ã‚‚å‹è² æ°—é…ãŒä¼ã‚ã£ã¦ãã‚‹',
            'é€ƒã’ãƒ»å…ˆè¡Œç­–ã§ãƒ¬ãƒ¼ã‚¹ã‚’æœ‰åˆ©ã«é‹ã¹ã‚‹ã€‚ãã®ã¾ã¾æŠ¼ã—åˆ‡ã‚Œã‚‹å¯èƒ½æ€§ã‚‚ååˆ†',
            'å·®ã—é¦¬ã¨ã—ã¦æœ«è„šãŒæ­¦å™¨ã€‚ç›´ç·šã§ä¼¸ã³ã‚‹è„šãŒã‚ã‚Œã°ä¸€æ°—ã«æŠœã‘å‡ºã›ã‚‹',
            'å±•é–‹ãŒå‘ã‘ã°æµ®ä¸Šã™ã‚‹å¯èƒ½æ€§ã‚‚ã€‚ãƒ¬ãƒ¼ã‚¹ã®æµã‚Œæ¬¡ç¬¬ã§ã¯é¢ç™½ã„å­˜åœ¨',
            'äººæ°—ã¯ä½ã„ãŒä¾®ã‚Œãªã„å®ŸåŠ›ã‚’æŒã¤ã€‚ç©´ã‚’é–‹ã‘ã‚‹å¯èƒ½æ€§ã‚’ç§˜ã‚ã¦ã„ã‚‹',
            'ã‚¯ãƒ©ã‚¹ãŒä¸ŠãŒã£ãŸãŒå¯¾å¿œã§ãã‚‹åŠ›ã¯ã‚ã‚‹ã€‚ã“ã“ã§ã‚‚é€šç”¨ã™ã‚‹ç´ è³ªã¯ååˆ†',
            'ä¸ŠãŒã‚Šæœ€é€Ÿã‚’è¨˜éŒ²ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã€ç›´ç·šã§ã®ä¼¸ã³è„šã«æ³¨ç›®ã—ãŸã„'
        ];

        // ãƒ‡ãƒ¼ã‚¿å…¥åŠ›ã‚’ãƒ‘ãƒ¼ã‚¹
        function parseInputData(text) {
            const lines = text.trim().split('\n');
            if (lines.length < 2) return null;

            const raceName = lines[0].trim();
            const horses = [];

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                // é¦¬ç•ªã€å°ã€é¦¬åã‚’æŠ½å‡º
                const match = line.match(/^(\d+)\s+(â—|â—‹|â–³|â–²|\s)*\s+(.+)$/);
                if (match) {
                    const num = parseInt(match[1]);
                    const marks = (match[2] || '').replace(/\s/g, '').split('').filter(m => 'â—â—‹â–³â–²'.includes(m));
                    const name = match[3].trim();

                    horses.push({ num, marks, name });
                }
            }

            return { raceName, horses };
        }

        // è‡ªå‹•åˆ†é¡ãƒ­ã‚¸ãƒƒã‚¯
        function autoClassify() {
            const inputText = document.getElementById('input-data').value;
            const parsed = parseInputData(inputText);

            if (!parsed || parsed.horses.length === 0) {
                showStatus('âš ï¸ ãƒ‡ãƒ¼ã‚¿å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }

            raceData.raceName = parsed.raceName;
            raceData.horses = parsed.horses;

            // åˆ†é¡ãƒ«ãƒ¼ãƒ«é©ç”¨
            const classification = {
                honmei: null,
                taiko: null,
                tanana: [],
                renka: [],
                osae: [],
                excluded: []
            };

            parsed.horses.forEach(horse => {
                if (horse.marks.length === 0) {
                    classification.excluded.push(horse);
                    return;
                }

                const rightmost = horse.marks[horse.marks.length - 1];
                const count = horse.marks.length;

                if (rightmost === 'â—') {
                    if (!classification.honmei) classification.honmei = horse;
                    else classification.tanana.push(horse);
                } else if (rightmost === 'â—‹') {
                    if (!classification.taiko) classification.taiko = horse;
                    else classification.tanana.push(horse);
                } else if (rightmost === 'â–²' && count >= 3) {
                    classification.tanana.push(horse);
                } else if (rightmost === 'â–²' && count <= 2) {
                    classification.osae.push(horse);
                } else if (rightmost === 'â–³' && count >= 3) {
                    classification.renka.push(horse);
                } else if (rightmost === 'â–³' && count <= 2) {
                    classification.osae.push(horse);
                } else {
                    classification.osae.push(horse);
                }
            });

            raceData.classification = classification;
            renderClassification();
            showStatus(`âœ… ${parsed.horses.length}é ­ã‚’åˆ†é¡ã—ã¾ã—ãŸ`, 'success');
        }

        // åˆ†é¡çµæœã‚’è¡¨ç¤º
        function renderClassification() {
            const panel = document.getElementById('classification-panel');
            const c = raceData.classification;

            let html = '';

            // æœ¬å‘½
            html += `
                <div class="horse-category" style="border-color: #FFD700;"
                     ondragover="handleDragOver(event)"
                     ondragleave="handleDragLeave(event)"
                     ondrop="handleDrop(event, 'honmei')">
                    <div class="category-header">
                        <span class="category-icon">ğŸ¥‡</span>
                        <span>æœ¬å‘½</span>
                    </div>
            `;
            if (c.honmei) {
                html += `<div class="horse-tag" draggable="true" data-horse-num="${c.honmei.num}"
                         ondragstart="handleDragStart(event)" ondragend="handleDragEnd(event)">${c.honmei.num}ç•ª ${c.honmei.name}</div>
                        <select class="comment-select" onchange="updateComment('honmei', this.value)">
                            <option value="">ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆã‚’é¸æŠï¼‰</option>
                            ${PRESET_COMMENTS.map((comment, i) =>
                                `<option value="${i}">${comment.substring(0, 30)}...</option>`
                            ).join('')}
                        </select>
                    </div>
                `;
            }

            // å¯¾æŠ—
            if (c.taiko) {
                html += `
                    <div class="horse-category" style="border-color: #C0C0C0;">
                        <div class="category-header">
                            <span class="category-icon">ğŸ¥ˆ</span>
                            <span>å¯¾æŠ—</span>
                        </div>
                        <div class="horse-tag">${c.taiko.num}ç•ª ${c.taiko.name}</div>
                        <select class="comment-select" onchange="updateComment('taiko', this.value)">
                            <option value="">ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆã‚’é¸æŠï¼‰</option>
                            ${PRESET_COMMENTS.map((comment, i) =>
                                `<option value="${i}">${comment.substring(0, 30)}...</option>`
                            ).join('')}
                        </select>
                    </div>
                `;
            }

            // å˜ç©´
            if (c.tanana.length > 0) {
                html += `
                    <div class="horse-category" style="border-color: #CD7F32;">
                        <div class="category-header">
                            <span class="category-icon">ğŸ¥‰</span>
                            <span>å˜ç©´</span>
                        </div>
                        ${c.tanana.map(h => `<div class="horse-tag">${h.num}ç•ª ${h.name}</div>`).join('')}
                    </div>
                `;
            }

            // é€£ä¸‹
            if (c.renka.length > 0) {
                html += `
                    <div class="horse-category">
                        <div class="category-header">
                            <span class="category-icon">ğŸ“Œ</span>
                            <span>é€£ä¸‹</span>
                        </div>
                        ${c.renka.map(h => `<div class="horse-tag">${h.num}ç•ª ${h.name}</div>`).join('')}
                    </div>
                `;
            }

            // æŠ‘ãˆï¼ˆé¸æŠå¯èƒ½ï¼‰
            if (c.osae.length > 0) {
                html += `
                    <div class="horse-category">
                        <div class="category-header">
                            <span class="category-icon">ğŸ“</span>
                            <span>æŠ‘ãˆ</span>
                        </div>
                        <div class="checkbox-option">
                            <input type="checkbox" id="use-osae" onchange="toggleOsae()">
                            <label for="use-osae">è²·ã„ç›®ã«æŠ‘ãˆé¦¬ã‚’å«ã‚ã‚‹</label>
                        </div>
                        ${c.osae.map(h => `<div class="horse-tag">${h.num}ç•ª ${h.name}</div>`).join('')}
                    </div>
                `;
            }

            // é™¤å¤–
            if (c.excluded.length > 0) {
                html += `
                    <div class="horse-category" style="opacity: 0.5;">
                        <div class="category-header">
                            <span class="category-icon">ğŸš«</span>
                            <span>é™¤å¤–</span>
                        </div>
                        ${c.excluded.map(h => `<div class="horse-tag">${h.num}ç•ª ${h.name}</div>`).join('')}
                    </div>
                `;
            }

            panel.innerHTML = html;
        }

        // ã‚³ãƒ¡ãƒ³ãƒˆæ›´æ–°
        function updateComment(type, index) {
            if (index !== '') {
                raceData.comments[type] = PRESET_COMMENTS[parseInt(index)];
            } else {
                raceData.comments[type] = '';
            }
        }

        // æŠ‘ãˆé¦¬ã®ä½¿ç”¨åˆ‡æ›¿
        function toggleOsae() {
            const checkbox = document.getElementById('use-osae');
            console.log('æŠ‘ãˆé¦¬ã‚’ä½¿ç”¨:', checkbox.checked);
        }

        // è²·ã„ç›®ç”Ÿæˆ
        function generateBetting() {
            const c = raceData.classification;

            if (!c.honmei || !c.taiko) {
                showStatus('âš ï¸ æœ¬å‘½ãƒ»å¯¾æŠ—ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }

            const useOsae = document.getElementById('use-osae')?.checked || false;

            let output = 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';
            output += 'ğŸ’° æœ¬æ—¥ã®æ¨å¥¨è²·ã„ç›®\n';
            output += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';
            output += raceData.raceName + '\n\n';

            // æœ¬å‘½ãƒ»å¯¾æŠ—
            output += `ğŸ¥‡ æœ¬å‘½: ${c.honmei.num}ç•ª ${c.honmei.name}\n`;
            if (raceData.comments.honmei) {
                output += `   ğŸ’¬ ${raceData.comments.honmei}\n`;
            }
            output += '\n';

            output += `ğŸ¥ˆ å¯¾æŠ—: ${c.taiko.num}ç•ª ${c.taiko.name}\n`;
            if (raceData.comments.taiko) {
                output += `   ğŸ’¬ ${raceData.comments.taiko}\n`;
            }
            output += '\n';

            // å˜ç©´
            if (c.tanana.length > 0) {
                output += `ğŸ¥‰ å˜ç©´: ${c.tanana.map(h => `${h.num}ç•ª ${h.name}`).join(', ')}\n\n`;
            }

            // é€£ä¸‹
            if (c.renka.length > 0) {
                output += `ğŸ“Œ é€£ä¸‹: ${c.renka.map(h => `${h.num}ç•ª ${h.name}`).join(', ')}\n\n`;
            }

            // æŠ‘ãˆï¼ˆä½¿ç”¨ã™ã‚‹å ´åˆï¼‰
            if (useOsae && c.osae.length > 0) {
                output += `ğŸ“ æŠ‘ãˆ: ${c.osae.map(h => `${h.num}ç•ª ${h.name}`).join(', ')}\n\n`;
            }

            output += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';
            output += 'ğŸ’° æ¨å¥¨é¦¬åˆ¸\n';
            output += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';

            // è²·ã„ç›®ç”Ÿæˆ
            const honmei = c.honmei.num;
            const taiko = c.taiko.num;
            const tanana = c.tanana.map(h => h.num);
            const renka = c.renka.map(h => h.num);
            const osae = useOsae ? c.osae.map(h => h.num) : [];

            // åŸºæœ¬
            output += 'ã€æœ¬ç·šã€‘\n';
            output += `å˜å‹: ${honmei}ç•ª (100å††)\n`;
            output += `é¦¬å˜: ${honmei}-${taiko} (100å††)\n\n`;

            // ä¸‰é€£å˜ãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            output += 'ã€ä¸‰é€£å˜ãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã€‘\n';
            let sanrentanPoints = 0;

            // æœ¬å‘½è»¸
            const thirdHorses = [...tanana, ...renka, ...osae];
            if (thirdHorses.length > 0) {
                output += `${honmei}-${taiko}-${thirdHorses.join(',')}`;
                const points = thirdHorses.length;
                sanrentanPoints += points;
                output += `  (${points}ç‚¹Ã—100å††= ${points * 100}å††)\n`;
            }

            if (tanana.length > 0) {
                const thirdForTanana = [...tanana.slice(1), ...renka, ...osae].filter(n => n !== tanana[0]);
                if (thirdForTanana.length > 0) {
                    output += `${honmei}-${tanana[0]}-${thirdForTanana.join(',')}`;
                    const points = thirdForTanana.length;
                    sanrentanPoints += points;
                    output += `  (${points}ç‚¹Ã—100å††= ${points * 100}å††)\n`;
                }
            }

            // å¯¾æŠ—è»¸
            if (thirdHorses.length > 0) {
                output += `${taiko}-${honmei}-${thirdHorses.join(',')}`;
                const points = thirdHorses.length;
                sanrentanPoints += points;
                output += `  (${points}ç‚¹Ã—100å††= ${points * 100}å††)\n`;
            }

            output += `\nåˆè¨ˆ: ${sanrentanPoints}ç‚¹ = ${sanrentanPoints * 100}å††\n\n`;

            // ãƒ¯ã‚¤ãƒ‰
            output += 'ã€ãƒ¯ã‚¤ãƒ‰ã€‘\n';
            output += `${honmei}-${taiko}, `;
            if (tanana.length > 0) {
                output += `${honmei}-${tanana[0]}, ${taiko}-${tanana[0]}`;
            }
            if (renka.length > 0) {
                output += `, ${honmei}-${renka[0]}, ${taiko}-${renka[0]}`;
            }
            output += '\n\n';

            output += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';
            const totalCost = 200 + sanrentanPoints * 100 + 500;
            output += `ğŸ’µ åˆè¨ˆæŠ•è³‡é¡: ç´„${totalCost.toLocaleString()}å††\n`;
            output += `ğŸ¯ çš„ä¸­ç›®æ¨™: ä¸‰é€£å˜ Â¥10,000ä»¥ä¸Š\n`;
            output += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';

            document.getElementById('betting-output').textContent = output;
            document.getElementById('betting-panel').hidden = false;

            showStatus('âœ… è²·ã„ç›®ã‚’ç”Ÿæˆã—ã¾ã—ãŸ', 'success');
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.className = `status-message status-${type}`;
            statusDiv.textContent = message;
            setTimeout(() => {
                statusDiv.textContent = '';
                statusDiv.className = '';
            }, 5000);
        }

        // ã‚¯ãƒªã‚¢
        function clearAll() {
            document.getElementById('input-data').value = '';
            document.getElementById('classification-panel').innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ã€Œè‡ªå‹•åˆ†é¡ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</p>';
            document.getElementById('betting-panel').hidden = true;
            raceData = {
                raceName: '',
                horses: [],
                classification: {
                    honmei: null,
                    taiko: null,
                    tanana: [],
                    renka: [],
                    osae: [],
                    excluded: []
                },
                comments: {
                    honmei: '',
                    taiko: ''
                }
            };
            showStatus('âœ… ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'success');
        }

        // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        function loadSampleData() {
            const sampleData = `å¤§äº•1R ï¼“æ­³(ä¸‰)(å››)ãƒ€1,600mï¼ˆ12é ­ï¼‰ ç™ºèµ°æ™‚åˆ»14:30
1    â—â–³â—‹â–³    ãƒãƒªã‚¢ã‚·ã‚ªãƒ³
2    â–³â–³â—    ã‚¬ãƒ³ãƒŠãƒ¼ãƒ«
3    â—‹â—â–³â—‹    ã‚µãƒ«ã‚¸ãƒ¥
4    â–²    ãƒ”ãƒ¼ã‚¹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
5    â–³â–³â–²â–²    ãƒˆãƒ¼ã‚»ãƒ³ã‚¢ã‚·ãƒ¥ãƒªãƒ¼
6        ã‚¤ã‚µã‚´ãƒ¼ãƒ«ãƒ‰
7    â–²â–³    ã‚³ãƒ‘ã‚«ãƒãƒ¼ãƒŠ
8    â–²â–³â–³    ãƒã‚¸ã‚«ãƒ«ãƒ¬ã‚¤ãƒ³ãƒœãƒ¼
9        ãƒ¬ã‚¤ãƒ´ãƒ³ãƒã‚¹ã‚¿ãƒ¼
10    â–²â—‹â—â–³    ãƒŸãƒ¦ãƒ³ã‚¬ãƒ¼
11    â–³â–²â–²    ãƒãƒƒã‚¯ãƒ«ãƒ™ãƒªãƒ¼
12    â–³â–³    ãƒœãƒ³ãƒãƒ†ã‚£`;

            document.getElementById('input-data').value = sampleData;
            showStatus('âœ… ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ', 'success');
        }

        // ãƒ‡ãƒ¼ã‚¿ä¿å­˜ï¼ˆLocalStorageï¼‰
        function saveData() {
            if (!raceData.raceName) {
                showStatus('âš ï¸ ä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }

            const saveKey = prompt('ä¿å­˜åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', 'ãƒ¬ãƒ¼ã‚¹äºˆæƒ³_' + new Date().toLocaleDateString('ja-JP'));
            if (!saveKey) return;

            try {
                localStorage.setItem('nankan_race_' + saveKey, JSON.stringify(raceData));
                showStatus('âœ… ã€Œ' + saveKey + 'ã€ã¨ã—ã¦ä¿å­˜ã—ã¾ã—ãŸ', 'success');
            } catch (e) {
                showStatus('âŒ ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message, 'error');
            }
        }

        // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆLocalStorageï¼‰
        function loadData() {
            const keys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('nankan_race_')) {
                    keys.push(key.replace('nankan_race_', ''));
                }
            }

            if (keys.length === 0) {
                showStatus('âš ï¸ ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }

            const selection = prompt('èª­ã¿è¾¼ã‚€ãƒ‡ãƒ¼ã‚¿ã‚’é¸æŠã—ã¦ãã ã•ã„:\n\n' + keys.map((k, i) => (i + 1) + '. ' + k).join('\n') + '\n\nç•ªå·ã‚’å…¥åŠ›:', '1');
            if (!selection) return;

            const index = parseInt(selection) - 1;
            if (index < 0 || index >= keys.length) {
                showStatus('âŒ ç„¡åŠ¹ãªé¸æŠã§ã™', 'error');
                return;
            }

            try {
                const loadKey = 'nankan_race_' + keys[index];
                const data = JSON.parse(localStorage.getItem(loadKey));
                raceData = data;

                // ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ
                const inputLines = [data.raceName];
                data.horses.forEach(h => {
                    const marks = h.marks.join('');
                    inputLines.push(`${h.num}    ${marks}    ${h.name}`);
                });
                document.getElementById('input-data').value = inputLines.join('\n');

                renderClassification();
                showStatus('âœ… ã€Œ' + keys[index] + 'ã€ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ', 'success');
            } catch (e) {
                showStatus('âŒ èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message, 'error');
            }
        }

        // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹
        let draggedHorseNum = null;

        function handleDragStart(e) {
            draggedHorseNum = parseInt(e.target.dataset.horseNum);
            e.target.classList.add('dragging');
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function handleDrop(e, targetCategory) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');

            if (!draggedHorseNum) return;

            // é¦¬ã‚’æ¤œç´¢
            const horse = raceData.horses.find(h => h.num === draggedHorseNum);
            if (!horse) return;

            // å…ƒã®ã‚«ãƒ†ã‚´ãƒªã‹ã‚‰å‰Šé™¤
            const c = raceData.classification;
            if (c.honmei && c.honmei.num === draggedHorseNum) c.honmei = null;
            else if (c.taiko && c.taiko.num === draggedHorseNum) c.taiko = null;
            else {
                ['tanana', 'renka', 'osae', 'excluded'].forEach(cat => {
                    const index = c[cat].findIndex(h => h.num === draggedHorseNum);
                    if (index !== -1) c[cat].splice(index, 1);
                });
            }

            // æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªã«è¿½åŠ 
            if (targetCategory === 'honmei') c.honmei = horse;
            else if (targetCategory === 'taiko') c.taiko = horse;
            else c[targetCategory].push(horse);

            renderClassification();
            showStatus('âœ… ã‚«ãƒ†ã‚´ãƒªã‚’å¤‰æ›´ã—ã¾ã—ãŸ', 'success');
        }
    </script>
</body>
</html>
